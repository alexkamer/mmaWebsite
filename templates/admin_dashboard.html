{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl shadow-lg p-8 mb-8">
        <div class="text-center">
            <h1 class="text-4xl font-bold mb-2">‚öôÔ∏è Admin Dashboard</h1>
            <p class="text-blue-200 text-lg">Data Update Management & Monitoring</p>
        </div>
    </div>

    <!-- Status Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">Fighters</p>
                    <p id="stat-fighters" class="text-2xl font-bold text-gray-900">--</p>
                </div>
                <div class="text-4xl">ü•ä</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">Events</p>
                    <p id="stat-events" class="text-2xl font-bold text-gray-900">--</p>
                </div>
                <div class="text-4xl">üé™</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">Fights</p>
                    <p id="stat-fights" class="text-2xl font-bold text-gray-900">--</p>
                </div>
                <div class="text-4xl">‚öîÔ∏è</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">Rankings</p>
                    <p id="stat-rankings" class="text-2xl font-bold text-gray-900">--</p>
                </div>
                <div class="text-4xl">üèÜ</div>
            </div>
        </div>
    </div>

    <!-- Last Update Times -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h2 class="text-xl font-bold mb-4">‚è±Ô∏è Last Update Times</h2>
        <div id="last-updates" class="space-y-2">
            <p class="text-gray-500">Loading...</p>
        </div>
    </div>

    <!-- Manual Update Triggers -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h2 class="text-xl font-bold mb-4">üöÄ Manual Updates</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <button onclick="triggerUpdate('incremental')"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200">
                Incremental Update
            </button>

            <button onclick="triggerUpdate('post-event')"
                    class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200">
                Post-Event Update
            </button>

            <button onclick="triggerUpdate('rankings')"
                    class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200">
                Rankings Update
            </button>

            <button onclick="triggerUpdate('odds')"
                    class="bg-orange-600 hover:bg-orange-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200">
                Odds Update
            </button>
        </div>

        <!-- Status Messages -->
        <div id="update-status" class="mt-4 hidden">
            <div class="p-4 rounded-lg" id="update-status-content"></div>
        </div>
    </div>

    <!-- Scheduled Jobs -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold mb-4">üìÖ Scheduled Jobs</h2>
        <div id="scheduled-jobs" class="space-y-4">
            <p class="text-gray-500">Loading...</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDataStats();
    loadUpdateStatus();

    // Refresh status every 30 seconds
    setInterval(loadUpdateStatus, 30000);
});

async function loadDataStats() {
    try {
        const response = await fetch('/admin/data/stats');
        const data = await response.json();

        document.getElementById('stat-fighters').textContent = data.fighters?.toLocaleString() || '--';
        document.getElementById('stat-events').textContent = data.events?.toLocaleString() || '--';
        document.getElementById('stat-fights').textContent = data.fights?.toLocaleString() || '--';
        document.getElementById('stat-rankings').textContent = data.rankings?.toLocaleString() || '--';
    } catch (error) {
        console.error('Error loading data stats:', error);
    }
}

async function loadUpdateStatus() {
    try {
        const response = await fetch('/admin/updates/status');
        const data = await response.json();

        // Display last update times
        const lastUpdates = document.getElementById('last-updates');
        if (data.last_updates && Object.keys(data.last_updates).length > 0) {
            lastUpdates.innerHTML = '';
            for (const [job, info] of Object.entries(data.last_updates)) {
                const lastRun = info.last_run ? new Date(info.last_run).toLocaleString() : 'Never';
                const status = info.status || 'unknown';
                const statusColor = status === 'success' ? 'text-green-600' : 'text-red-600';

                lastUpdates.innerHTML += `
                    <div class="flex justify-between items-center py-2 border-b">
                        <span class="font-medium">${formatJobName(job)}</span>
                        <div class="text-right">
                            <span class="text-gray-600 text-sm">${lastRun}</span>
                            <span class="${statusColor} ml-2 text-xs">‚óè</span>
                        </div>
                    </div>
                `;
            }
        } else {
            lastUpdates.innerHTML = '<p class="text-gray-500">No update history available</p>';
        }

        // Display scheduled jobs
        const scheduledJobs = document.getElementById('scheduled-jobs');
        if (data.scheduled_jobs && data.scheduled_jobs.length > 0) {
            scheduledJobs.innerHTML = '';
            data.scheduled_jobs.forEach(job => {
                const nextRun = job.next_run ? new Date(job.next_run).toLocaleString() : 'Not scheduled';
                scheduledJobs.innerHTML += `
                    <div class="border-l-4 border-blue-500 pl-4 py-2">
                        <div class="font-medium">${job.name}</div>
                        <div class="text-sm text-gray-600">Next run: ${nextRun}</div>
                        <div class="text-xs text-gray-500">${job.trigger}</div>
                    </div>
                `;
            });
        } else {
            scheduledJobs.innerHTML = '<p class="text-gray-500">No scheduled jobs</p>';
        }
    } catch (error) {
        console.error('Error loading update status:', error);
    }
}

async function triggerUpdate(type) {
    const statusDiv = document.getElementById('update-status');
    const statusContent = document.getElementById('update-status-content');

    // Show loading state
    statusDiv.classList.remove('hidden');
    statusContent.className = 'p-4 rounded-lg bg-blue-50 border border-blue-200';
    statusContent.innerHTML = `<p class="text-blue-800">‚è≥ Triggering ${formatJobName(type)} update...</p>`;

    try {
        const endpoint = type === 'rankings' ? '/admin/rankings/update' : `/admin/updates/${type}`;
        const response = await fetch(endpoint, { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            statusContent.className = 'p-4 rounded-lg bg-green-50 border border-green-200';
            let message = `<p class="text-green-800 font-medium">‚úÖ ${data.message}</p>`;

            // Add stats if available
            if (data.stats) {
                message += '<div class="mt-2 text-sm text-green-700">';
                for (const [key, value] of Object.entries(data.stats)) {
                    if (typeof value === 'number') {
                        message += `<div>${formatStatName(key)}: ${value}</div>`;
                    }
                }
                message += '</div>';
            }

            statusContent.innerHTML = message;

            // Reload status after update
            setTimeout(loadUpdateStatus, 2000);
        } else {
            statusContent.className = 'p-4 rounded-lg bg-red-50 border border-red-200';
            statusContent.innerHTML = `<p class="text-red-800">‚ùå Error: ${data.error || 'Update failed'}</p>`;
        }
    } catch (error) {
        statusContent.className = 'p-4 rounded-lg bg-red-50 border border-red-200';
        statusContent.innerHTML = `<p class="text-red-800">‚ùå Network error: ${error.message}</p>`;
    }
}

function formatJobName(jobName) {
    return jobName
        .replace(/_/g, ' ')
        .replace(/\b\w/g, l => l.toUpperCase());
}

function formatStatName(statName) {
    return statName
        .replace(/_/g, ' ')
        .replace(/\b\w/g, l => l.toUpperCase());
}
</script>
{% endblock %}
