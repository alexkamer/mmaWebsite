{% extends "base.html" %}

{% block content %}
<style>
/* Enhanced link styles for better UX */
.fighter-link {
    position: relative;
    transition: all 0.2s ease;
}

.fighter-link:hover {
    transform: translateY(-1px);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.event-link:hover {
    transform: translateX(2px);
}

/* Subtle cursor pointer for clickable elements */
.fighter-link, .event-link {
    cursor: pointer;
}

/* Link icon indicator */
.fighter-link::after {
    content: "üîó";
    opacity: 0;
    margin-left: 4px;
    font-size: 0.7em;
    transition: opacity 0.2s ease;
}

.fighter-link:hover::after {
    opacity: 0.6;
}
</style>
<div class="container mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl shadow-lg p-8 mb-8">
        <div class="text-center">
            <h1 class="text-4xl font-bold mb-2">ü§ñ MMA Intelligence</h1>
            <p class="text-blue-200 text-lg">Ask any question about MMA fighters, fights, and statistics</p>
            <p class="text-blue-100 text-sm mt-2">Powered by AI ‚Ä¢ Over 73,000 fights analyzed ‚Ä¢ üîó Click names to view profiles ‚Ä¢ üì° Live data integration</p>
        </div>
    </div>

    <!-- Service Status (initially hidden, shown if there are issues) -->
    <div id="service-status" class="hidden mb-6">
        <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded">
            <div class="flex">
                <div class="ml-3">
                    <p class="text-sm text-red-700" id="status-message">
                        Service configuration issue detected. Please check Azure OpenAI setup.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Query Interface -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="mb-6">
            <label for="question-input" class="block text-lg font-medium text-gray-900 mb-3">
                What would you like to know about MMA?
            </label>
            
            <!-- Question Input -->
            <div class="flex gap-3">
                <input 
                    type="text" 
                    id="question-input" 
                    placeholder="e.g., What is Jon Jones's UFC record? Who has the most knockouts in heavyweight?"
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg"
                    maxlength="500"
                >
                <button 
                    id="ask-button" 
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    <span id="ask-button-text">Ask</span>
                    <span id="ask-button-loading" class="hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Thinking...
                    </span>
                </button>
            </div>
            
            <!-- Character counter -->
            <div class="mt-2 text-right">
                <span id="char-counter" class="text-sm text-gray-500">0/500</span>
            </div>
        </div>

        <!-- Quick Examples -->
        <div class="mb-6">
            <h3 class="text-sm font-medium text-gray-700 mb-3">üí° Try asking:</h3>
            <div class="flex flex-wrap gap-2">
                <button class="example-question px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-full transition duration-200" 
                        data-question="What is Conor McGregor's UFC record?">
                    What is Conor McGregor's UFC record?
                </button>
                <button class="example-question px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-full transition duration-200" 
                        data-question="Who has the most knockouts in heavyweight?">
                    Who has the most knockouts in heavyweight?
                </button>
                <button class="example-question px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-full transition duration-200" 
                        data-question="Which weight class has the highest finishing rate?">
                    Which weight class has the highest finishing rate?
                </button>
            </div>
            
            <!-- More examples link -->
            <div class="mt-3">
                <button id="show-examples" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    Show more examples ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- Results Area -->
    <div id="results-container" class="hidden">
        <!-- Query Result -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-start gap-4">
                <!-- Question -->
                <div class="flex-1">
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-blue-600">‚ùì</span>
                            <span class="font-medium text-blue-900">Your Question</span>
                        </div>
                        <p id="asked-question" class="text-gray-800"></p>
                    </div>

                    <!-- Data Cards (for records, simple stats) -->
                    <div id="data-cards-section" class="hidden bg-blue-50 p-4 rounded-lg mb-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-blue-600">üìä</span>
                            <span class="font-medium text-blue-900">Fighter Record</span>
                            <span id="cards-type-badge" class="px-2 py-1 text-xs bg-blue-200 text-blue-800 rounded-full"></span>
                        </div>
                        <div id="record-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                    </div>

                    <!-- Data Table (for comparisons, rankings) -->
                    <div id="data-table-section" class="hidden bg-blue-50 p-4 rounded-lg mb-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-blue-600">üìä</span>
                            <span class="font-medium text-blue-900">Data</span>
                            <span id="table-type-badge" class="px-2 py-1 text-xs bg-blue-200 text-blue-800 rounded-full"></span>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="results-table" class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead id="table-head" class="bg-gray-50"></thead>
                                <tbody id="table-body" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Answer -->
                    <div class="bg-green-50 p-4 rounded-lg mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-green-600">ü§ñ</span>
                                <span class="font-medium text-green-900">Analysis</span>
                                <span id="cache-indicator" class="hidden px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">Cached ‚ö°</span>
                                <span id="live-data-indicator" class="hidden px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">Live Data üì°</span>
                            </div>
                            <div id="confidence-indicator" class="hidden flex items-center gap-2">
                                <span class="text-xs text-gray-600">Confidence:</span>
                                <div class="flex items-center gap-1">
                                    <div id="confidence-bar" class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div id="confidence-fill" class="h-full bg-green-500 transition-all duration-500"></div>
                                    </div>
                                    <span id="confidence-percent" class="text-xs text-gray-600"></span>
                                </div>
                            </div>
                        </div>
                        <div id="answer-text" class="text-gray-800 leading-relaxed"></div>
                    </div>

                    <!-- Follow-up Suggestions -->
                    <div id="follow-up-section" class="hidden bg-blue-50 p-4 rounded-lg mb-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-blue-600">üí°</span>
                            <span class="font-medium text-blue-900">You might also ask:</span>
                        </div>
                        <div id="follow-up-suggestions" class="flex flex-wrap gap-2">
                            <!-- Follow-up suggestions will be populated here -->
                        </div>
                    </div>

                    <!-- Query Details (collapsible) -->
                    <div class="border-t pt-4">
                        <button id="toggle-details" class="text-sm text-gray-600 hover:text-gray-800 flex items-center gap-1">
                            <span>Show query details</span>
                            <svg class="w-4 h-4 transform transition-transform" id="details-arrow" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        
                        <div id="query-details" class="hidden mt-3 p-3 bg-gray-50 rounded border text-sm">
                            <div class="mb-3">
                                <strong class="text-gray-700">SQL Query Generated:</strong>
                                <pre id="sql-query" class="mt-1 p-2 bg-white rounded border text-xs overflow-x-auto"><code></code></pre>
                            </div>
                            <div>
                                <strong class="text-gray-700">Results:</strong>
                                <span id="result-count" class="text-gray-600 ml-2"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Examples Modal -->
    <div id="examples-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Example Questions</h3>
                    <button id="close-examples" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="examples-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Examples will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    <div id="error-message" class="hidden mb-6">
        <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded">
            <div class="flex">
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Error</h3>
                    <p class="text-sm text-red-700 mt-1" id="error-text"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const questionInput = document.getElementById('question-input');
    const askButton = document.getElementById('ask-button');
    const askButtonText = document.getElementById('ask-button-text');
    const askButtonLoading = document.getElementById('ask-button-loading');
    const resultsContainer = document.getElementById('results-container');
    const errorMessage = document.getElementById('error-message');
    const charCounter = document.getElementById('char-counter');
    const serviceStatus = document.getElementById('service-status');
    
    // Check service health on load
    fetch('/query/health')
        .then(response => response.json())
        .then(data => {
            if (!data.agno_configured || !data.environment_variables_set) {
                serviceStatus.classList.remove('hidden');
                askButton.disabled = true;
                
                let message = 'Service configuration issue: ';
                if (!data.environment_variables_set) {
                    message += 'Azure OpenAI environment variables not set. ';
                }
                if (!data.agno_configured) {
                    message += 'Agno agents not initialized (likely due to authentication issues). ';
                }
                message += 'Please check your Azure OpenAI credentials.';
                
                document.getElementById('status-message').textContent = message;
            }
        })
        .catch(error => {
            console.error('Health check failed:', error);
            serviceStatus.classList.remove('hidden');
        });

    // Character counter
    questionInput.addEventListener('input', function() {
        const length = this.value.length;
        charCounter.textContent = `${length}/500`;
        askButton.disabled = length === 0 || length > 500;
        
        if (length > 450) {
            charCounter.classList.add('text-orange-500');
        } else if (length > 500) {
            charCounter.classList.add('text-red-500');
        } else {
            charCounter.classList.remove('text-orange-500', 'text-red-500');
        }
    });

    // Enable ask button when there's input
    questionInput.addEventListener('input', function() {
        askButton.disabled = this.value.trim().length === 0;
    });

    // Enter key to submit
    questionInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !askButton.disabled) {
            askQuestion();
        }
    });

    // Ask button click
    askButton.addEventListener('click', askQuestion);

    // Example question buttons
    document.querySelectorAll('.example-question').forEach(button => {
        button.addEventListener('click', function() {
            const question = this.dataset.question;
            questionInput.value = question;
            questionInput.dispatchEvent(new Event('input')); // Trigger input event
            askQuestion();
        });
    });

    // Query details toggle
    document.getElementById('toggle-details').addEventListener('click', function() {
        const details = document.getElementById('query-details');
        const arrow = document.getElementById('details-arrow');
        
        if (details.classList.contains('hidden')) {
            details.classList.remove('hidden');
            arrow.style.transform = 'rotate(180deg)';
            this.querySelector('span').textContent = 'Hide query details';
        } else {
            details.classList.add('hidden');
            arrow.style.transform = 'rotate(0deg)';
            this.querySelector('span').textContent = 'Show query details';
        }
    });

    // Examples modal
    const showExamplesBtn = document.getElementById('show-examples');
    const examplesModal = document.getElementById('examples-modal');
    const closeExamplesBtn = document.getElementById('close-examples');
    const examplesContent = document.getElementById('examples-content');

    showExamplesBtn.addEventListener('click', function() {
        loadExamples();
        examplesModal.classList.remove('hidden');
    });

    closeExamplesBtn.addEventListener('click', function() {
        examplesModal.classList.add('hidden');
    });

    // Close modal on outside click
    examplesModal.addEventListener('click', function(e) {
        if (e.target === examplesModal) {
            examplesModal.classList.add('hidden');
        }
    });

    function askQuestion() {
        const question = questionInput.value.trim();
        
        if (!question) return;

        // Show loading state
        setLoadingState(true);
        hideError();
        
        fetch('/query/ask-v2', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ question: question })
        })
        .then(response => response.json())
        .then(data => {
            setLoadingState(false);
            
            if (data.success) {
                displayResult(data);
            } else {
                showError(data.error || 'An error occurred while processing your question.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            setLoadingState(false);
            showError('Network error. Please try again.');
        });
    }

    function setLoadingState(loading) {
        if (loading) {
            askButtonText.classList.add('hidden');
            askButtonLoading.classList.remove('hidden');
            askButton.disabled = true;
            questionInput.disabled = true;
        } else {
            askButtonText.classList.remove('hidden');
            askButtonLoading.classList.add('hidden');
            askButton.disabled = questionInput.value.trim().length === 0;
            questionInput.disabled = false;
        }
    }

    function displayResult(data) {
        console.log('üîç FRONTEND: Received data:', data);
        console.log('üîç FRONTEND: Presentation:', data.presentation);
        console.log('üîç FRONTEND: Classification:', data.classification);
        console.log('üîç FRONTEND: Data length:', data.data?.length);
        
        // Set the question
        document.getElementById('asked-question').textContent = data.question;
        
        // Handle new multi-agent response structure
        const analysisText = data.analysis || data.response || 'No analysis available';
        document.getElementById('answer-text').innerHTML = marked.parse(analysisText);
        
        // Display follow-up suggestions if available
        displayFollowUpSuggestions(data.classification);
        
        // Display confidence score if available
        displayConfidenceScore(data.classification);
        
        // Show cache indicator if result was cached
        displayCacheIndicator(data.cached);
        
        // Show live data indicator if using real-time data
        displayLiveDataIndicator(data.live_data);
        
        // Handle data presentation
        const presentation = data.presentation;
        const tableSection = document.getElementById('data-table-section');
        const cardsSection = document.getElementById('data-cards-section');
        
        if (presentation && (presentation.format_type === 'comparison' || presentation.format_type === 'table') && data.data && data.data.length > 0) {
            console.log('üîç FRONTEND: Showing table/comparison');
            console.log('üîç FRONTEND: Format:', presentation.format_type);
            console.log('üîç FRONTEND: Table headers:', presentation.table_headers);

            // Show table section, hide cards
            tableSection.classList.remove('hidden');
            cardsSection.classList.add('hidden');

            // Set table type badge
            const badge = document.getElementById('table-type-badge');
            const questionType = data.classification?.question_type || 'data';
            badge.textContent = questionType.replace('_', ' ').toUpperCase();

            // Create table - use the headers from the API response
            const headers = presentation.table_headers || Object.keys(data.data[0] || {});
            console.log('üîç FRONTEND: Using headers:', headers);

            // For comparisons with side_by_side layout, use special rendering
            if (presentation.format_type === 'comparison' && presentation.visual_layout === 'side_by_side') {
                createComparisonTable(data.data, headers, presentation.highlight_fields);
            } else {
                createDataTable(data.data, headers);
            }
            
        } else if (presentation && (presentation.format_type === 'list' || data.classification?.question_type === 'fight_history') && data.data && data.data.length > 0) {
            // Treat "list" format as table for fight history
            tableSection.classList.remove('hidden');
            cardsSection.classList.add('hidden');
            
            // Set table type badge
            const badge = document.getElementById('table-type-badge');
            badge.textContent = 'FIGHT HISTORY';
            
            // Create table with user-friendly headers for fight history
            // Use the column names from the enhanced SQL query patterns
            const availableKeys = Object.keys(data.data[0] || {});
            const preferredHeaders = ['date', 'event', 'opponent', 'result', 'method', 'finish'];
            const headers = preferredHeaders.filter(h => availableKeys.includes(h)).concat(
                availableKeys.filter(k => !preferredHeaders.includes(k))
            );
            createDataTable(data.data, headers);
            
        } else if (presentation && (presentation.format_type === 'cards' || data.classification?.question_type === 'record_lookup') && data.data && data.data.length > 0) {
            // Show cards section, hide table
            cardsSection.classList.remove('hidden');
            tableSection.classList.add('hidden');
            
            // Set cards type badge
            const cardsBadge = document.getElementById('cards-type-badge');
            cardsBadge.textContent = 'UFC RECORD';
            
            // Create record cards
            createRecordCards(data.data[0]); // Usually just one fighter's record
            
        } else {
            // Hide both sections for analysis-only presentations
            tableSection.classList.add('hidden');
            cardsSection.classList.add('hidden');
        }
        
        // Update query details
        document.getElementById('sql-query').textContent = data.sql_query || 'N/A';
        document.getElementById('result-count').textContent = `${data.row_count || 0} rows returned`;
        
        resultsContainer.classList.remove('hidden');
        
        // Reset query details to collapsed state
        const details = document.getElementById('query-details');
        const arrow = document.getElementById('details-arrow');
        details.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
        document.querySelector('#toggle-details span').textContent = 'Show query details';
        
        // Scroll to results
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    function createDataTable(data, headers) {
        console.log('üîç FRONTEND: createDataTable called with:', {data: data.length, headers});
        
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        
        console.log('üîç FRONTEND: Table elements found:', {tableHead: !!tableHead, tableBody: !!tableBody});
        
        // Clear existing content
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';
        
        // If we have data, use the actual keys from the first row to ensure proper mapping
        const actualHeaders = data.length > 0 ? Object.keys(data[0]) : headers;
        console.log('üîç FRONTEND: Actual data keys:', actualHeaders);
        console.log('üîç FRONTEND: Provided headers:', headers);
        
        // Create a mapping between display headers and data keys
        const headerMapping = {};
        headers.forEach(displayHeader => {
            // Try to find the matching key in the data
            const lowerDisplayHeader = displayHeader.toLowerCase();
            const matchingKey = actualHeaders.find(key => 
                key.toLowerCase() === lowerDisplayHeader || 
                key.toLowerCase().replace(/_/g, '') === lowerDisplayHeader.replace(/ /g, '')
            );
            headerMapping[displayHeader] = matchingKey || displayHeader;
            console.log('üîç FRONTEND: Mapping', displayHeader, '->', headerMapping[displayHeader]);
        });
        
        // Create header row
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
            console.log('üîç FRONTEND: Creating header for:', header);
            const th = document.createElement('th');
            th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
            th.textContent = formatHeaderName(header);
            headerRow.appendChild(th);
        });
        tableHead.appendChild(headerRow);
        console.log('üîç FRONTEND: Headers created, headerRow children:', headerRow.children.length);
        
        // Create data rows
        console.log('üîç FRONTEND: Creating data rows for', data.length, 'rows');
        data.forEach((row, index) => {
            console.log('üîç FRONTEND: Processing row', index, ':', row);
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            
            headers.forEach(header => {
                const td = document.createElement('td');
                td.className = 'px-4 py-3 text-sm text-gray-900';
                
                // Use the mapped key to get the actual value
                const dataKey = headerMapping[header];
                const value = row[dataKey];
                console.log('üîç FRONTEND: Header:', header, 'DataKey:', dataKey, 'Value:', value);
                
                if (value === null || value === undefined) {
                    td.textContent = '-';
                } else if (header.toLowerCase().includes('date') || header === 'Date') {
                    // Format dates nicely
                    td.textContent = formatDate(value);
                } else if (header.toLowerCase().includes('winner') || header.toLowerCase().includes('result') || header === 'Result') {
                    // Style result/winner cells
                    td.innerHTML = `<span class="font-medium text-blue-800">${value}</span>`;
                } else if (header.toLowerCase().includes('name') || header === 'Opponent') {
                    // Style fighter names with photos and links
                    const photoKey = header === 'Opponent' ? 'opponent_photo' : 'fighter_photo';
                    const idKey = header === 'Opponent' ? 'opponent_id' : 'fighter_id';
                    const photoUrl = row[photoKey];
                    const fighterId = row[idKey];
                    
                    if (photoUrl && photoUrl.startsWith('http')) {
                        if (fighterId) {
                            // Create clickable fighter link with photo
                            td.innerHTML = `
                                <div class="flex items-center gap-3">
                                    <img src="${photoUrl}" alt="${value}" class="w-8 h-8 rounded-full object-cover" 
                                         onerror="this.style.display='none'">
                                    <a href="/fighter/${fighterId}" class="fighter-link font-medium text-blue-600 hover:text-blue-800 hover:underline">${value}</a>
                                </div>
                            `;
                        } else {
                            td.innerHTML = `
                                <div class="flex items-center gap-3">
                                    <img src="${photoUrl}" alt="${value}" class="w-8 h-8 rounded-full object-cover" 
                                         onerror="this.style.display='none'">
                                    <span class="font-medium">${value}</span>
                                </div>
                            `;
                        }
                    } else {
                        if (fighterId) {
                            td.innerHTML = `<a href="/fighter/${fighterId}" class="fighter-link font-medium text-blue-600 hover:text-blue-800 hover:underline">${value}</a>`;
                        } else {
                            td.innerHTML = `<span class="font-medium">${value}</span>`;
                        }
                    }
                } else if (header.toLowerCase().includes('event') || header === 'Event') {
                    // Style event names with links
                    const eventIdKey = 'event_id';
                    const eventId = row[eventIdKey];
                    
                    if (eventId) {
                        td.innerHTML = `<a href="/events?event_id=${eventId}" class="event-link text-purple-600 hover:text-purple-800 hover:underline font-medium">${value}</a>`;
                    } else {
                        td.innerHTML = `<span class="font-medium">${value}</span>`;
                    }
                } else {
                    td.textContent = value;
                }
                
                tr.appendChild(td);
            });
            
            tableBody.appendChild(tr);
            console.log('üîç FRONTEND: Row', index, 'added with', tr.children.length, 'cells');
        });
        
        console.log('üîç FRONTEND: Table creation complete. Total rows:', tableBody.children.length);
    }
    
    function formatHeaderName(header) {
        return header
            .replace(/_/g, ' ')
            .replace(/\b\w/g, l => l.toUpperCase());
    }
    
    function formatDate(dateString) {
        if (!dateString) return '-';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        } catch (e) {
            return dateString;
        }
    }

    function createComparisonTable(data, headers, highlightFields = []) {
        console.log('üîç FRONTEND: createComparisonTable called with:', {data: data.length, headers: headers.length});

        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');

        // Clear existing content
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';

        // Create header row with "Stat" column and fighter names
        const headerRow = document.createElement('tr');

        // First column: Stat name
        const statHeader = document.createElement('th');
        statHeader.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50';
        statHeader.textContent = 'Statistic';
        headerRow.appendChild(statHeader);

        // Fighter columns
        data.forEach(fighter => {
            const th = document.createElement('th');
            th.className = 'px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-50';
            th.textContent = fighter.full_name || 'Fighter';
            headerRow.appendChild(th);
        });
        tableHead.appendChild(headerRow);

        // Create rows for each stat
        const priorityFields = ['full_name', 'weight_class', 'age', 'height', 'reach', 'stance', 'wins', 'losses', 'total_fights'];
        const statFields = headers.filter(h => !['fighter_id', 'fighter_photo', 'full_name'].includes(h));

        // Reorder to show priority fields first
        const orderedFields = [
            ...priorityFields.filter(f => statFields.includes(f)),
            ...statFields.filter(f => !priorityFields.includes(f))
        ];

        orderedFields.forEach(field => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';

            // Highlight important fields
            if (highlightFields && highlightFields.includes(field)) {
                tr.className += ' bg-yellow-50';
            }

            // Stat name column
            const statName = document.createElement('td');
            statName.className = 'px-4 py-3 text-sm font-medium text-gray-900 bg-gray-50';
            statName.textContent = formatHeaderName(field);
            tr.appendChild(statName);

            // Fighter value columns
            data.forEach((fighter, idx) => {
                const td = document.createElement('td');
                td.className = 'px-4 py-3 text-sm text-center';

                let value = fighter[field];

                // Format value
                if (value === null || value === undefined) {
                    value = '-';
                } else if (typeof value === 'number') {
                    // Round decimals to 1-2 places
                    value = Number.isInteger(value) ? value : value.toFixed(field.includes('avg') ? 1 : 2);
                }

                td.textContent = value;

                // Add comparative styling for numeric fields (highlight better stat)
                if (typeof fighter[field] === 'number' && data.length === 2) {
                    const otherFighter = data[1 - idx];
                    const otherValue = otherFighter[field];

                    if (typeof otherValue === 'number') {
                        // Higher is better for most stats
                        const higherIsBetter = !field.includes('loss') && !field.includes('age');

                        if (higherIsBetter && fighter[field] > otherValue) {
                            td.className += ' text-green-700 font-semibold';
                        } else if (!higherIsBetter && fighter[field] < otherValue) {
                            td.className += ' text-green-700 font-semibold';
                        } else if (fighter[field] === otherValue) {
                            td.className += ' text-gray-600';
                        } else {
                            td.className += ' text-gray-500';
                        }
                    }
                }

                tr.appendChild(td);
            });

            tableBody.appendChild(tr);
        });

        console.log('üîç FRONTEND: Comparison table created successfully');
    }

    function createRecordCards(recordData) {
        const container = document.getElementById('record-cards');
        container.innerHTML = '';
        
        // Define the stats to display with styling
        const stats = [
            { key: 'wins', label: 'Wins', color: 'green', icon: '‚úÖ' },
            { key: 'losses', label: 'Losses', color: 'red', icon: '‚ùå' },
            { key: 'draws', label: 'Draws', color: 'yellow', icon: '‚ö™' },
            { key: 'draws_or_no_contests', label: 'Draws/NC', color: 'gray', icon: '‚ö´' },
            { key: 'no_contests', label: 'No Contests', color: 'gray', icon: '‚ö´' }
        ];
        
        stats.forEach(stat => {
            const value = recordData[stat.key] || 0;
            
            // Skip if value is 0 and it's draws or no contests (to save space)
            if (value === 0 && (stat.key === 'draws' || stat.key === 'no_contests' || stat.key === 'draws_or_no_contests')) {
                return;
            }
            
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg p-4 text-center border-2 border-gray-200 hover:shadow-md transition-shadow';
            
            // Color-code the border based on stat type
            if (stat.color === 'green') card.classList.add('border-green-200', 'hover:border-green-300');
            else if (stat.color === 'red') card.classList.add('border-red-200', 'hover:border-red-300');
            else if (stat.color === 'yellow') card.classList.add('border-yellow-200', 'hover:border-yellow-300');
            else card.classList.add('border-gray-200', 'hover:border-gray-300');
            
            card.innerHTML = `
                <div class="text-2xl mb-2">${stat.icon}</div>
                <div class="text-3xl font-bold text-gray-900 mb-1">${value}</div>
                <div class="text-sm font-medium text-gray-600 uppercase tracking-wide">${stat.label}</div>
            `;
            
            container.appendChild(card);
        });
        
        // If record data includes fighter name, show it with link
        if (recordData.full_name || recordData.fighter_name) {
            const nameHeader = document.querySelector('#data-cards-section .font-medium');
            const fighterName = recordData.full_name || recordData.fighter_name;
            const fighterId = recordData.fighter_id;
            
            if (fighterId) {
                nameHeader.innerHTML = `<a href="/fighter/${fighterId}" class="text-blue-600 hover:text-blue-800 hover:underline">${fighterName}</a> - UFC Record`;
            } else {
                nameHeader.textContent = `${fighterName} - UFC Record`;
            }
        }
    }

    function showError(message) {
        document.getElementById('error-text').textContent = message;
        errorMessage.classList.remove('hidden');
        resultsContainer.classList.add('hidden');
    }

    function hideError() {
        errorMessage.classList.add('hidden');
    }

    function loadExamples() {
        fetch('/query/examples')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderExamples(data.examples);
                }
            })
            .catch(error => {
                console.error('Error loading examples:', error);
            });
    }

    function renderExamples(examples) {
        examplesContent.innerHTML = '';
        
        examples.forEach(category => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'mb-6';
            
            categoryDiv.innerHTML = `
                <h4 class="font-semibold text-gray-900 mb-3">${category.category}</h4>
                <div class="space-y-2">
                    ${category.questions.map(question => `
                        <button class="block w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded border transition duration-200 example-modal-question" 
                                data-question="${question}">
                            <span class="text-sm text-gray-700">${question}</span>
                        </button>
                    `).join('')}
                </div>
            `;
            
            examplesContent.appendChild(categoryDiv);
        });
        
        // Add click handlers for example questions in modal
        document.querySelectorAll('.example-modal-question').forEach(button => {
            button.addEventListener('click', function() {
                const question = this.dataset.question;
                questionInput.value = question;
                questionInput.dispatchEvent(new Event('input'));
                examplesModal.classList.add('hidden');
                askQuestion();
            });
        });
    }
    
    function displayFollowUpSuggestions(classification) {
        const followUpSection = document.getElementById('follow-up-section');
        const suggestionsContainer = document.getElementById('follow-up-suggestions');
        
        if (classification && classification.follow_up_suggestions && classification.follow_up_suggestions.length > 0) {
            // Clear existing suggestions
            suggestionsContainer.innerHTML = '';
            
            // Add each suggestion as a clickable button
            classification.follow_up_suggestions.forEach(suggestion => {
                const button = document.createElement('button');
                button.className = 'px-3 py-2 bg-white hover:bg-blue-100 text-blue-800 text-sm rounded-lg border border-blue-200 transition duration-200 follow-up-question';
                button.textContent = suggestion;
                button.setAttribute('data-question', suggestion);
                
                // Add click handler
                button.addEventListener('click', function() {
                    const question = this.getAttribute('data-question');
                    questionInput.value = question;
                    questionInput.dispatchEvent(new Event('input'));
                    askQuestion();
                });
                
                suggestionsContainer.appendChild(button);
            });
            
            // Show the follow-up section
            followUpSection.classList.remove('hidden');
        } else {
            // Hide the follow-up section if no suggestions
            followUpSection.classList.add('hidden');
        }
    }
    
    function displayConfidenceScore(classification) {
        const confidenceIndicator = document.getElementById('confidence-indicator');
        const confidenceFill = document.getElementById('confidence-fill');
        const confidencePercent = document.getElementById('confidence-percent');
        
        if (classification && classification.confidence && typeof classification.confidence === 'number') {
            const confidence = Math.round(classification.confidence * 100);
            
            // Show the confidence indicator
            confidenceIndicator.classList.remove('hidden');
            
            // Update the progress bar
            confidenceFill.style.width = `${confidence}%`;
            confidencePercent.textContent = `${confidence}%`;
            
            // Color-code based on confidence level
            if (confidence >= 80) {
                confidenceFill.className = 'h-full bg-green-500 transition-all duration-500';
            } else if (confidence >= 60) {
                confidenceFill.className = 'h-full bg-yellow-500 transition-all duration-500';
            } else {
                confidenceFill.className = 'h-full bg-red-500 transition-all duration-500';
            }
        } else {
            // Hide the confidence indicator if no confidence score
            confidenceIndicator.classList.add('hidden');
        }
    }
    
    function displayCacheIndicator(cached) {
        const cacheIndicator = document.getElementById('cache-indicator');
        
        if (cached) {
            cacheIndicator.classList.remove('hidden');
        } else {
            cacheIndicator.classList.add('hidden');
        }
    }
    
    function displayLiveDataIndicator(liveData) {
        const liveDataIndicator = document.getElementById('live-data-indicator');
        
        if (liveData) {
            liveDataIndicator.classList.remove('hidden');
        } else {
            liveDataIndicator.classList.add('hidden');
        }
    }
});
</script>

<!-- Add Marked.js for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}