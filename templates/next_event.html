{% extends "base.html" %}

{# Macro to calculate implied probability from American odds #}
{% macro calc_probability(odds) %}
    {% if odds %}
        {% set odds_int = odds|int %}
        {% if odds_int < 0 %}
            {{ ((-odds_int / (-odds_int + 100)) * 100)|round(1) }}
        {% else %}
            {{ ((100 / (odds_int + 100)) * 100)|round(1) }}
        {% endif %}
    {% else %}
        50.0
    {% endif %}
{% endmacro %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    {% if event %}
    <!-- Event Header -->
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl shadow-2xl p-8 mb-8 text-white">
        <h1 class="text-4xl font-bold mb-4">{{ event.event_name }}</h1>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="flex items-center space-x-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span class="text-lg font-semibold">{{ event.date }}</span>
            </div>
            <div class="flex items-center space-x-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span class="text-lg">{{ event.venue_name }}</span>
            </div>
            <div class="flex items-center space-x-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-lg">{{ event.city }}, {{ event.country }}</span>
            </div>
        </div>
    </div>

    <!-- Betting Insights Summary -->
    {% set total_fights = fights|length %}
    {% set favorites_count = namespace(value=0) %}
    {% set avg_favorite_prob = [] %}
    {% for fight in fights %}
        {% if fight.fighter_1_odds and fight.fighter_1_odds|int < 0 %}
            {% set favorites_count.value = favorites_count.value + 1 %}
            {% set _ = avg_favorite_prob.append(calc_probability(fight.fighter_1_odds)|float) %}
        {% endif %}
        {% if fight.fighter_2_odds and fight.fighter_2_odds|int < 0 %}
            {% set favorites_count.value = favorites_count.value + 1 %}
            {% set _ = avg_favorite_prob.append(calc_probability(fight.fighter_2_odds)|float) %}
        {% endif %}
    {% endfor %}

    <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl shadow-lg p-6 mb-8 border-2 border-purple-200">
        <div class="flex items-center justify-center mb-4">
            <div class="bg-gradient-to-r from-blue-500 to-purple-500 rounded-full p-2 mr-3">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">üìä Betting Insights</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white rounded-lg p-4 shadow-md text-center transform transition hover:scale-105">
                <div class="text-3xl font-bold text-purple-600">{{ total_fights }}</div>
                <div class="text-sm text-gray-600 font-medium">Total Fights</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-md text-center transform transition hover:scale-105">
                <div class="text-3xl font-bold text-blue-600">{{ favorites_count.value }}</div>
                <div class="text-sm text-gray-600 font-medium">Clear Favorites (‚≠ê)</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-md text-center transform transition hover:scale-105">
                <div class="text-3xl font-bold text-green-600">
                    {% if avg_favorite_prob|length > 0 %}
                        {{ (avg_favorite_prob|sum / avg_favorite_prob|length)|round(1) }}%
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="text-sm text-gray-600 font-medium">Avg Favorite Probability</div>
            </div>
        </div>
    </div>

    <!-- Fight Card -->
    <div class="space-y-6">
        {% set last_segment = namespace(value='') %}
        {% for fight in fights %}
            <!-- Card Segment Header -->
            {% if fight.card_segment != last_segment.value %}
                {% set last_segment.value = fight.card_segment %}
                <div class="mt-8 mb-4">
                    <div class="bg-gray-100 border-l-4 border-purple-600 px-4 py-3 rounded">
                        <h3 class="text-lg font-bold text-gray-800">{{ fight.card_segment or 'Fight Card' }}</h3>
                    </div>
                </div>
            {% endif %}

            <!-- Main Event gets special treatment -->
            {% if loop.first %}
            <div class="bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl shadow-2xl overflow-hidden border-4 border-red-500 transform transition-all duration-300 hover:scale-102">
                <div class="bg-gradient-to-r from-red-600 to-orange-600 text-white py-3 px-6">
                    <h3 class="text-2xl font-bold text-center">üèÜ MAIN EVENT üèÜ</h3>
                </div>
                <div class="p-8">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 items-center">
                        <!-- Fighter 1 -->
                        <div class="md:col-span-2 flex flex-col items-center text-center space-y-3">
                            {% if fight.fighter_1_headshot %}
                            <div class="w-32 h-32 rounded-full overflow-hidden ring-4 ring-red-500 shadow-xl">
                                <img src="{{ fight.fighter_1_headshot }}" alt="{{ fight.fighter_1_name }}" class="w-full h-full object-cover">
                            </div>
                            {% endif %}
                            <a href="/fighters?fighter_id={{ fight.fighter_1_id }}" class="text-2xl font-bold text-gray-900 hover:text-red-600 transition">
                                {{ fight.fighter_1_name }}
                            </a>
                            <p class="text-lg text-gray-700 font-semibold">{{ fight.fighter_1_record }}</p>
                            {% if fight.fighter_1_odds %}
                            <div class="{% if fight.fighter_1_odds|int < 0 %}bg-red-500{% else %}bg-blue-500{% endif %} text-white px-4 py-2 rounded-full font-bold text-lg shadow-lg">
                                {% if fight.fighter_1_odds|int < 0 %}‚≠ê {% endif %}{{ fight.fighter_1_odds }}
                            </div>
                            <div class="w-full mt-2">
                                <div class="text-center text-sm font-bold text-gray-700 mb-1">{{ calc_probability(fight.fighter_1_odds) }}% Win Probability</div>
                                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-500" style="width: {{ calc_probability(fight.fighter_1_odds) }}%"></div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Center VS -->
                        <div class="flex flex-col items-center justify-center space-y-4">
                            <div class="w-20 h-20 bg-gradient-to-br from-red-500 to-orange-500 rounded-full flex items-center justify-center shadow-xl">
                                <span class="text-white text-2xl font-black">VS</span>
                            </div>
                            <span class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full text-sm font-bold shadow-lg">
                                {{ fight.weight_class }}
                            </span>
                            <div class="flex gap-2 mt-4">
                                <a href="{{ url_for('games.fight_preview', fighter1_id=fight.fighter_1_id, fighter2_id=fight.fighter_2_id, event_id=event.event_id, fight_id=fight.fight_id) }}"
                                   class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                                    üîç Preview
                                </a>
                                <a href="{{ url_for('games.tale_of_tape') }}?fighter1={{ fight.fighter_1_id }}&fighter2={{ fight.fighter_2_id }}"
                                   class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                                    ‚öñÔ∏è Compare
                                </a>
                            </div>
                        </div>

                        <!-- Fighter 2 -->
                        <div class="md:col-span-2 flex flex-col items-center text-center space-y-3">
                            {% if fight.fighter_2_headshot %}
                            <div class="w-32 h-32 rounded-full overflow-hidden ring-4 ring-red-500 shadow-xl">
                                <img src="{{ fight.fighter_2_headshot }}" alt="{{ fight.fighter_2_name }}" class="w-full h-full object-cover">
                            </div>
                            {% endif %}
                            <a href="/fighters?fighter_id={{ fight.fighter_2_id }}" class="text-2xl font-bold text-gray-900 hover:text-red-600 transition">
                                {{ fight.fighter_2_name }}
                            </a>
                            <p class="text-lg text-gray-700 font-semibold">{{ fight.fighter_2_record }}</p>
                            {% if fight.fighter_2_odds %}
                            <div class="{% if fight.fighter_2_odds|int < 0 %}bg-red-500{% else %}bg-blue-500{% endif %} text-white px-4 py-2 rounded-full font-bold text-lg shadow-lg">
                                {% if fight.fighter_2_odds|int < 0 %}‚≠ê {% endif %}{{ fight.fighter_2_odds }}
                            </div>
                            <div class="w-full mt-2">
                                <div class="text-center text-sm font-bold text-gray-700 mb-1">{{ calc_probability(fight.fighter_2_odds) }}% Win Probability</div>
                                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                    <div class="bg-gradient-to-r from-red-500 to-red-600 h-3 rounded-full transition-all duration-500" style="width: {{ calc_probability(fight.fighter_2_odds) }}%"></div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Regular Fights -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden transform transition-all duration-300 hover:shadow-xl hover:scale-102">
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 items-center">
                        <!-- Fighter 1 -->
                        <div class="md:col-span-2 flex items-center space-x-4">
                            {% if fight.fighter_1_headshot %}
                            <div class="w-20 h-20 rounded-full overflow-hidden ring-2 ring-purple-500 shadow-lg flex-shrink-0">
                                <img src="{{ fight.fighter_1_headshot }}" alt="{{ fight.fighter_1_name }}" class="w-full h-full object-cover">
                            </div>
                            {% endif %}
                            <div class="flex-1">
                                <a href="/fighters?fighter_id={{ fight.fighter_1_id }}" class="text-xl font-bold text-gray-900 hover:text-purple-600 transition">
                                    {{ fight.fighter_1_name }}
                                </a>
                                <p class="text-sm text-gray-600 font-medium">{{ fight.fighter_1_record }}</p>
                                {% if fight.fighter_1_odds %}
                                <div class="inline-block mt-1 {% if fight.fighter_1_odds|int < 0 %}bg-red-100 text-red-700{% else %}bg-blue-100 text-blue-700{% endif %} px-3 py-1 rounded-full text-sm font-bold">
                                    {% if fight.fighter_1_odds|int < 0 %}‚≠ê {% endif %}{{ fight.fighter_1_odds }}
                                </div>
                                <div class="mt-2">
                                    <div class="text-xs font-semibold text-gray-600 mb-1">{{ calc_probability(fight.fighter_1_odds) }}% win prob</div>
                                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                        <div class="bg-gradient-to-r from-blue-400 to-blue-500 h-2 rounded-full" style="width: {{ calc_probability(fight.fighter_1_odds) }}%"></div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Center VS -->
                        <div class="flex flex-col items-center justify-center space-y-3">
                            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-full flex items-center justify-center shadow-lg">
                                <span class="text-white text-xl font-black">VS</span>
                            </div>
                            <span class="px-3 py-1 bg-gradient-to-r from-purple-400 to-pink-400 text-white rounded-full text-xs font-bold shadow">
                                {{ fight.weight_class }}
                            </span>
                            <div class="flex gap-2">
                                <a href="{{ url_for('games.fight_preview', fighter1_id=fight.fighter_1_id, fighter2_id=fight.fighter_2_id, event_id=event.event_id, fight_id=fight.fight_id) }}"
                                   class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-medium rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                                    üîç
                                </a>
                                <a href="{{ url_for('games.tale_of_tape') }}?fighter1={{ fight.fighter_1_id }}&fighter2={{ fight.fighter_2_id }}"
                                   class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-medium rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                                    ‚öñÔ∏è
                                </a>
                            </div>
                        </div>

                        <!-- Fighter 2 -->
                        <div class="md:col-span-2 flex items-center space-x-4 justify-end">
                            <div class="flex-1 text-right">
                                <a href="/fighters?fighter_id={{ fight.fighter_2_id }}" class="text-xl font-bold text-gray-900 hover:text-purple-600 transition">
                                    {{ fight.fighter_2_name }}
                                </a>
                                <p class="text-sm text-gray-600 font-medium">{{ fight.fighter_2_record }}</p>
                                {% if fight.fighter_2_odds %}
                                <div class="inline-block mt-1 {% if fight.fighter_2_odds|int < 0 %}bg-red-100 text-red-700{% else %}bg-blue-100 text-blue-700{% endif %} px-3 py-1 rounded-full text-sm font-bold">
                                    {% if fight.fighter_2_odds|int < 0 %}‚≠ê {% endif %}{{ fight.fighter_2_odds }}
                                </div>
                                <div class="mt-2">
                                    <div class="text-xs font-semibold text-gray-600 mb-1">{{ calc_probability(fight.fighter_2_odds) }}% win prob</div>
                                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                        <div class="bg-gradient-to-r from-red-400 to-red-500 h-2 rounded-full" style="width: {{ calc_probability(fight.fighter_2_odds) }}%"></div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% if fight.fighter_2_headshot %}
                            <div class="w-20 h-20 rounded-full overflow-hidden ring-2 ring-purple-500 shadow-lg flex-shrink-0">
                                <img src="{{ fight.fighter_2_headshot }}" alt="{{ fight.fighter_2_name }}" class="w-full h-full object-cover">
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
        <h2 class="text-2xl font-bold mb-4">No Upcoming Events</h2>
        <p class="text-gray-600">There are no upcoming UFC events scheduled at this time.</p>
    </div>
    {% endif %}
</div>

{% endblock %} 