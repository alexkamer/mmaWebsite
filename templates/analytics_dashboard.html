{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl shadow-lg p-8 mb-8">
        <div class="text-center">
            <h1 class="text-4xl font-bold mb-2">üìä MMA Intelligence Analytics</h1>
            <p class="text-indigo-200 text-lg">Performance metrics and usage statistics</p>
            <p class="text-indigo-100 text-sm mt-2">Real-time dashboard ‚Ä¢ Auto-refreshes every 30 seconds</p>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="text-center py-12">
        <div class="inline-flex items-center">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-600">Loading analytics data...</span>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard-content" class="hidden">
        <!-- Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <span class="text-blue-600 text-xl">üîç</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-500 text-sm font-medium">Total Queries</p>
                        <p id="total-queries" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <span class="text-green-600 text-xl">‚ö°</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-500 text-sm font-medium">Cache Hit Rate</p>
                        <p id="cache-hit-rate" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <span class="text-purple-600 text-xl">üí¨</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-500 text-sm font-medium">Active Sessions</p>
                        <p id="active-sessions" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-orange-100 rounded-lg">
                        <span class="text-orange-600 text-xl">üì¶</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-500 text-sm font-medium">Cached Results</p>
                        <p id="cached-results" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Cache Performance Chart -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Cache Performance</h3>
                <div class="relative">
                    <canvas id="cache-chart" width="400" height="200"></canvas>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                    <div class="text-center">
                        <div class="text-green-600 font-semibold" id="cache-hits">-</div>
                        <div class="text-gray-500">Cache Hits</div>
                    </div>
                    <div class="text-center">
                        <div class="text-red-600 font-semibold" id="cache-misses">-</div>
                        <div class="text-gray-500">Cache Misses</div>
                    </div>
                </div>
            </div>

            <!-- Popular Question Types -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Popular Question Types</h3>
                <div id="question-types-list" class="space-y-3">
                    <!-- Question types will be populated here -->
                </div>
            </div>
        </div>

        <!-- Recent Queries -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Recent Cached Queries</h3>
                <button id="clear-cache-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition duration-200">
                    Clear Cache
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Question</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cached At</th>
                        </tr>
                    </thead>
                    <tbody id="recent-queries-table" class="bg-white divide-y divide-gray-200">
                        <!-- Recent queries will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Auto-refresh indicator -->
    <div class="fixed bottom-4 right-4 bg-white rounded-lg shadow-lg p-3 border-l-4 border-blue-500">
        <div class="flex items-center text-sm">
            <div id="refresh-indicator" class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
            <span class="text-gray-600">Last updated: <span id="last-update-time">-</span></span>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let cacheChart = null;
    
    // Load analytics data
    function loadAnalytics() {
        fetch('/analytics/api/stats')
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    updateDashboard(result.data);
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('dashboard-content').classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error loading analytics:', error);
            });
    }
    
    function updateDashboard(data) {
        // Update overview cards
        document.getElementById('total-queries').textContent = data.overview.total_queries;
        document.getElementById('cache-hit-rate').textContent = data.overview.cache_hit_rate;
        document.getElementById('active-sessions').textContent = data.overview.active_sessions;
        document.getElementById('cached-results').textContent = data.overview.cached_results;
        
        // Update cache performance chart
        updateCacheChart(data.cache_performance);
        
        // Update question types
        updateQuestionTypes(data.popular_question_types);
        
        // Update recent queries table
        updateRecentQueries(data.recent_queries);
        
        // Update last update time
        const now = new Date();
        document.getElementById('last-update-time').textContent = now.toLocaleTimeString();
        
        // Flash the refresh indicator
        const indicator = document.getElementById('refresh-indicator');
        indicator.classList.remove('bg-green-500');
        indicator.classList.add('bg-blue-500');
        setTimeout(() => {
            indicator.classList.remove('bg-blue-500');
            indicator.classList.add('bg-green-500');
        }, 500);
    }
    
    function updateCacheChart(cacheData) {
        const ctx = document.getElementById('cache-chart').getContext('2d');
        
        if (cacheChart) {
            cacheChart.destroy();
        }
        
        cacheChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Hits', 'Misses'],
                datasets: [{
                    data: [cacheData.hits, cacheData.misses],
                    backgroundColor: ['#10B981', '#EF4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Update cache stats
        document.getElementById('cache-hits').textContent = cacheData.hits;
        document.getElementById('cache-misses').textContent = cacheData.misses;
    }
    
    function updateQuestionTypes(questionTypes) {
        const container = document.getElementById('question-types-list');
        container.innerHTML = '';
        
        const sortedTypes = Object.entries(questionTypes)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5); // Top 5 question types
        
        sortedTypes.forEach(([type, count]) => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center py-2';
            div.innerHTML = `
                <span class="text-gray-700 capitalize">${type.replace('_', ' ')}</span>
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">${count}</span>
            `;
            container.appendChild(div);
        });
        
        if (sortedTypes.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No data available</p>';
        }
    }
    
    function updateRecentQueries(queries) {
        const tbody = document.getElementById('recent-queries-table');
        tbody.innerHTML = '';
        
        queries.forEach(query => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `
                <td class="px-4 py-3 text-sm text-gray-900">${query.question}</td>
                <td class="px-4 py-3 text-sm">
                    <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-medium">
                        ${query.type.replace('_', ' ')}
                    </span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-500">${new Date(query.cached_at).toLocaleString()}</td>
            `;
            tbody.appendChild(tr);
        });
        
        if (queries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="px-4 py-8 text-center text-gray-500">No recent queries</td></tr>';
        }
    }
    
    // Clear cache button
    document.getElementById('clear-cache-btn').addEventListener('click', function() {
        if (confirm('Are you sure you want to clear all caches? This will remove all cached queries and conversation history.')) {
            fetch('/analytics/api/clear-cache', { method: 'POST' })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Caches cleared successfully!');
                        loadAnalytics(); // Refresh the dashboard
                    } else {
                        alert('Error clearing caches: ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('Error clearing caches:', error);
                    alert('Network error while clearing caches');
                });
        }
    });
    
    // Auto-refresh every 30 seconds
    setInterval(loadAnalytics, 30000);
    
    // Initial load
    loadAnalytics();
});
</script>
{% endblock %}